# Lab-002 - Updating Stacks with Security Groups

[Home](../README.md) |
[AWS Console](https://console.aws.amazon.com) |
Slides |
[Anatomy](anatomy.md) |
[lab-001](lab-001.md) |
lab-002 |
[lab-003](lab-003.md) |
[lab-004](lab-004.md) |
[lab-005](lab-005.md) |
[lab-006](lab-006.md)

## GOAL: Create SecurityGroup(s) on default VPC
* Create two SecurityGroups, 'app' and 'db'
* Groups will have no rules to start with. You will update the SecurityGroups 'app' to add rules.


![lab-002 SecurityGroups](https://raw.githubusercontent.com/sunil-tailor/lab_cloudformation/master/diagrams/lab-002-g1.png)


## Outcome

This lab will be successful when you have provisioned 2 Security groups one called 'app' and another called 'db' and added the rules to the app security group. You are observing how using a single template file to update a maintian rules for a security group. This allows you to version control one file.


### Steps

<details>
<summary>Using AWS Console</summary>
<br/>


__ALL services > Management Tools > CloudFormation__
- Click __'Create Stack'__ Button

__Select template:__
- Choose __"Upload a template to Amazon S3"__
- Upload file `lab-002-part-1-sg-app-000.yaml`
- Click __"Next"__

__Specify Details:__
- Stack Details > __Stack Name__ : `lab-002-sg-<APP OR DB>-<YOUR NAME>`
  - Replace `<APP OR DB>` with __app__ or __db__
  - Replace `<YOUR NAME>` with your name in lowercase. This is to keep track of the stacks should you have loads of existing CloudFormation stacks.
- Click __'Next'__

__Options:__
- Permissions > IAM Role: `pg19meetupLabsRole`
- Click __'Next'__

__Review:__
- Check the settings
- Click __'Create'__

__NOTE:__ Repeat the process for both templates: `lab-002-part-1-sg-app-000.yaml` and `lab-002-part-1-sg-db-000.yaml`

Now you should have provisioned 2 security groups: `app` and `db`. Go to the AWS Console and view each of them the `app` Security Group should have no rules while the `db` Security Group should have one rule for MySQL database port.

To view them goto:
- AWS Console > Services > EC2
- Network & Security > __Security Groups__   (Should be on the left hand side menu)

Now we now run the following templates in turn: `sg-app-rules-UPDATE-001.yaml`, `sg-app-rules-UPDATE-002.yaml`, `sg-app-rules-UPDATE-003.yaml`

The purpose of this lab is to understand how you can create a security group and add and remove rules from them.

</details>

<br/>

If you prefer to use the CLI then expand __Using AWS CLI__ for steps.

<details>
 <summary>Using AWS CLI</summary>

#### Validate your templates
```
aws cloudformation validate-template \
--template-body file://lab-002-part-1-sg-app-000.yaml \
--profile pg19

aws cloudformation validate-template \
--template-body file://lab-002-part-2-sg-db-000.yaml \
--profile pg19
```

#### Run 

```
aws cloudformation create-stack \
--stack-name lab-002-sg-app-<YOUR NAME> \
--template-body file://lab-002-part-1-sg-app-000.yaml \
--profile pg19
```

and 

```
aws cloudformation create-stack \
--stack-name lab-002-sg-db-<YOUR NAME> \
--template-body file://lab-002-part-2-sg-db-000.yaml \
--profile pg19
```
- Replace `<YOUR NAME>` with your name in lowercase. This is to keep track of the stacks should you have loads of existing CloudFormation stacks.

Now you should have provisioned 2 security groups: `app` and `db`. Go to the AWS Console and view each of them the `app` Security Group should have no rules while the `db` Security Group should have one rule for MySQL database port.

To view them goto:
- AWS Console > Services > EC2
- Network & Security > __Security Groups__  (Should be on the left hand side menu)

Now we now run the following templates in turn: `sg-app-rules-UPDATE-001.yaml`, `sg-app-rules-UPDATE-002.yaml`, `sg-app-rules-UPDATE-003.yaml`


```
aws cloudformation update-stack \
--stack-name lab-002-sg-app-<YOUR NAME> \
--template-body file://sg-app-rules-UPDATE-001.yaml \
--profile pg19
```

You will notice 2 new rules appear HTTP and HTTPS.


```
aws cloudformation update-stack \
--stack-name lab-002-sg-app-<YOUR NAME> \
--template-body file://sg-app-rules-UPDATE-002.yaml \
--profile pg19
```

After running this stack update you will notice that the 2 rules from the previous update have disappear and only the rule of SSH, port 22 is now present. This is because the template only contain this rule. 

```
aws cloudformation update-stack \
--stack-name lab-002-sg-app-<YOUR NAME> \
--template-body file://sg-app-rules-UPDATE-002.yaml \
--profile pg19
```

After running the final stack update you'll notice that all 3 rules are now present for SSH, HTTP and HTTPS.

</details>
<br/>
The purpose of this lab is to understand how you can create a security group and add and remove rules from them all from a single template.
<br/>
<br/>

---

## Analysis of Lab

* GroupName Constraints: Up to 255 characters in length. Cannot start with `sg-` .
* Constraints for EC2-VPC: a-z, A-Z, 0-9, spaces, and `._-:/()#,@[]+=;{}!$*`

```
AWSTemplateFormatVersion: "2010-09-09"
Description: Application Security Group
Resources:
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Application layer
      GroupName: app
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          CidrIp: 0.0.0.0/0

        - IpProtocol: tcp
          FromPort: '443'
          ToPort: '443'
          CidrIp: 0.0.0.0/0

        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: 0.0.0.0/0
```

## Lessons learned
* creating stack and performing updates through a single file.
* `GroupName:` has contraints. i.e. Cannot start with `sg-`.
* The template represents and maintains the list of rules. Removing a rule and applying the template will remove the rele from the stack Resource.

## Further Reading


## References
