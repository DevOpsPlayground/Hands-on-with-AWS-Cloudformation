
# Lab-001 - Create a CloudFormation Stack

[Home](../README.md) |
[AWS Console](https://console.aws.amazon.com) |
Slides |
[Anatomy](anatomy.md) |
lab-001 |
[lab-002](lab-002.md) |
[lab-003](lab-003.md) |
[lab-004](lab-004.md) |
[lab-005](lab-005.md) |
[lab-006](lab-006.md)


## GOAL: Create a Cloud Formation Stack to Provision a S3 Bucket with a custom name

* Create template to provision S3 bucket
* Parameter for Bucket Name
* Output of Bucket Name

![lab-001 S3 Bucket](https://raw.githubusercontent.com/sunil-tailor/lab_cloudformation/master/diagrams/lab-001-g1.png)

## Outcome

* Provision a new S3 bucket with using the name format: lab-001-<YOUR NAME>


### Steps

<details>
<summary>Using AWS Console</summary>

__ALL services > Management Tools > CloudFormation__
- Click __'Create Stack'__ Button

__Select template:__
- Choose __"Upload a template to Amazon S3"__
- Upload file "lab-001_S3Bucket.yaml"
- Click __"Next"__

__Specify Details:__
- Stack Details > __Stack Name__ : `lab-001-<YOUR NAME>`
- Parameters:
   - Lab-001: S3 Bucket > __Bucket Name__ : `pg19-<YOUR NAME>`
- Click 'Next'

__Options:__
- Permissions > IAM Role: `pg19meetupLabsRoleDemo`
- Click 'Next'

__Review:__
- Check the settings
- Click __'Create'__

</details>


<br/>

If you prefer to use the CLI then expand __Using AWS CLI__ for steps.

<details>
 <summary>Using AWS CLI</summary>

#### Validate your template
```
aws cloudformation validate-template \
--template-body file://cf-lab-001.yaml \
--profile training
{
   "Parameters": []
}
```

#### Run

```
aws cloudformation create-stack \
--stackname lab-001-<YOUR NAME> \
--template-body file://lab-001_S3Bucket.yaml \
--parameters file://lab-001-parameters.json
```

##### Sample Parameter
```
[
 {
   "ParameterKey": "pS3BucketName",
   "ParameterValue": "pg19-<YOUR NAME>"
 }
]
```
</details>


## GOAL: Create a Change Set to Update S3 bucket Stack

* Boolean Parameter to enabling Versioning on S3 Bucket
* Bucket Policy for Public Read Access

![lab-001 S3 Change Set Bucket](https://raw.githubusercontent.com/sunil-tailor/lab_cloudformation/master/diagrams/lab-001-g2.png)

## Outcome
* Applied S3 bucket policy to make bucket have public read access
* Added some tags to bucket

### Steps

<details>
<summary>Using AWS Console</summary>

__ALL services > Management Tools > CloudFormation__

- Click __'Actions__' > __'Create Change Set For New Stack'__ Button

__Choose a template:__
- Choose __"Upload a template to Amazon S3"__
- Upload file "lab-001_ChangeSet.yaml"
- Click __"Next"__

__Specify Details:__
- __Change set name__ : `lab-001-cs-<YOUR NAME>`
- __Description__ : `Change Set for lab-001, Goal 2.`
- Parameters:
   - __Bucket Name__ : `Leave as is`
   - __Enable Versioning__ : `true`
- Click 'Next'

__Options:__
- Permissions > IAM Role: `pg19meetupLabsRoleDemo`
- Click 'Next'

__Review:__
- Check the settings
- Click __'Create change set'__
__Overview:__

</details>

<br/>

If you prefer to use the CLI then expand __Using AWS CLI__ for steps.

<details>
 <summary>Using AWS CLI</summary>

#### Validate your template
```
aws cloudformation validate-template \
--template-body file://cf-lab-001.yaml \
--profile training
{
   "Parameters": []
}
```

#### Run

</details>

<br/>
<br/>

---

## Analysis of Lab
- Reviewed CloudFormation Template
- Created CloudFormation Stack
- Viewed the output of a CloudFormation Stack
- Understood how Change Sets work, their purpose

During this lab you provisioned a S3 bucket using a parameterise bucket name.


## Lessons learned
* How a CloudFormation Template is composed.
* Service Role vs Owner Permissions
* Condition Functions - `Fn::If`
* `AWS::CloudFormation::Interface` is a metadata key that defines how parameters are grouped and sorted in the AWS CloudFormation console. Its only used on AWS Console, AWS CLI and API do not use this metadata key and is placed under the parent `Metadata` tag in the CloudFormation YAML file.
* Protecting Resources from accidental deletion
  - DeletionPolicy
* Outputs - Name of S3 bucket
* Tags - applied to CF Stack useful for auditing purposes


## Notes
- __Stack name__ - must contain only letters, numbers, dashes and start with an alpha character.
- Protecting Resources from accidental deletion you have the following options:
    - Stack termination protection
    - Stack Level Policies
    - deletion policy
    - Using IAM policies



## Further Reading
1. AWS doc - CloudFormation > [AWS::CloudFormation::Interface](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-interface.html)
1. AWS API - CloudFormation > [AWS::S3::Bucket](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket.html)
1. AWS API - CloudFormation > [AWS::S3::BucketPolicy](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-s3-policy.html)


## References
1. YouTube - [AWS re:Invent 2017: Deep Dive on AWS CloudFormation (DEV317)](https://www.youtube.com/watch?v=01hy48R9Kr8), 29 Nov 2017
1. SlideShare - [DEV317_Deep Dive on AWS CloudFormation](https://www.slideshare.net/AmazonWebServices/dev317deep-dive-on-aws-cloudformation), By Anil Kumar (Senior Product Manager), Luis Colon (Senior Developer Advocate)
